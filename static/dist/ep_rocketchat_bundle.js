"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=(e,t)=>{localStorage.setItem(`${e}_historyCount`,t)},t=e=>localStorage.getItem(`${e}_historyCount`),o=()=>localStorage.getItem("lastActiveHeader"),a=(e,t,o)=>{localStorage.setItem(`${e}_unreadMentionedCount_${t}`,o)},n=(e,t)=>{localStorage.getItem(`${e}_unreadMentionedCount_${t}`)},r=(e,t)=>{localStorage.setItem(`${e}_newMessage`,t)},l=e=>localStorage.getItem(`${e}_newMessage`),s=(e,t)=>{localStorage.setItem(`${e}_unreadCount`,t)},i=e=>localStorage.getItem(`${e}_unreadCount`),c=()=>$(document).find('iframe[name="ace_outer"]').contents();var d=t=>{try{document.getElementById("ep_rocketchat_iframe").contentWindow.postMessage({externalCommand:"go",path:`/channel/${t.data.room}?layout=embedded`},"*"),setTimeout((()=>{$("#chat-loading").animate({opacity:0},{duration:500,complete:()=>{$("#chat-loading").css({display:"none"}),$("#ep_rocketchat_iframe").animate({opacity:1},500);const o=clientVars.userAgent.isMobile;let n=t.data.room;const l=t.padId,i=t.userId;n=n===`${l}-general-channel`?"general":n,s(n,0),r(n,0),a(n,i,0),e(n,0),(e=>{localStorage.setItem("lastActiveHeader",e)})(n),$(`#${n}_notification`).empty();const d=$(`#${n}_notification`).attr("data-headerid");let p=c().find("iframe").contents().find("#innerdocbody").find(`[headerid="${d}"]`)[0];p&&(p=p.shadowRoot,o||(p.querySelector(".bubbleNotify").style.display="none",p.querySelector(".mobileIcon").style.display="block",p.querySelector(".mobileIcon").style.marginTop="5px"),p.querySelectorAll(".counter").forEach((e=>{e.innerText=""})))}})}),500)}catch(e){console.log(e)}},p=e=>{if($("#ep_rocketchat_onlineUsersList").empty(),!e.data.onlineUsers)return;if(!e.data.onlineUsers.online)return;let t="";e.data.onlineUsers.online.forEach((({username:e})=>{console.info("element",e);const{padId:o,serverTimestamp:a}=clientVars;t+=`\n            <div data-userId="${e}" class="avatar">\n                <div\n                  class="ep_rocketchat_onlineUsersList_avatarImg"\n                  style="\n                    background: url(${`/static/getUserProfileImage/${e}/${o}?t=${a}`}) no-repeat 50% 50% ;\n                    background-size: 28px;\n                    background-color: #fff;\n                  ">\n                  </div>\n            </div>`})),t&&$("#ep_rocketchat_onlineUsersList").append(t)},u=e=>{try{const t=[],o=["h1","h2","h3","h4"],a=$('iframe[name="ace_outer"]').contents().find("iframe").contents().find("#innerdocbody").children("div").children(o);$(a).each((function(){const e=$(this).closest(".ace-line"),o=$(this).data("data-id")||e.attr("sectionid");t.push(o.toLowerCase())})),t.push(`${e.padId}-general-channel`);const n={type:"ep_rocketchat",action:e.data.forwardTo,userId:e.userId,padId:e.padId,data:{headerIds:t}};pad.collabClient.sendMessage(n)}catch(e){console.log(e)}};const h=e=>{const t=$("#toc"),o=t.scrollTop()+(t.height()-317);return{visible:$(e).offset().top+$(e).height()<=o}},m=e=>{const t=$(`#${e}_container`);if(t.attr("mentioned","true"),t.length&&"general"!==e){!1===h(t).visible&&$("#bottomNewMention").css({display:"block"})}},y=e=>{const t=$(`#${e}_container`);t.length&&"general"!==e&&t.attr("mentioned","false")},g=()=>{const e=()=>{const e=$("#tocItems").find("[mentioned=true]").last();e&&(!0===(e=>{let t;if(t=typeof e!==String?$(e):$(`#${e}`).nextAll("[mentioned=true]").last(),t.length)return!h(t).visible;return!1})(e)?$("#bottomNewMention").css({display:"block"}):$("#bottomNewMention").css({display:"none"}))};$("#toc").scroll((()=>{var t,o;t=e,o=100,clearTimeout(t._tId),t._tId=setTimeout((()=>{t()}),o)})),$("#bottomNewMention").click((()=>{const e=$("#bottomNewMention").attr("_lastscrolled");if(e){const t=$(`#${e}`),o=t.nextAll("[mentioned=true]").first();o.length?($("#bottomNewMention").attr("_lastscrolled",o.attr("id")),$(o)[0].scrollIntoView({behavior:"smooth"})):$(t)[0].scrollIntoView({behavior:"smooth"})}else{const e=$("#tocItems").find("[mentioned=true]");e.each((function(t){if(!1===h(this).visible)return $(this)[0].scrollIntoView({behavior:"smooth"}),$("#bottomNewMention").attr("_lastscrolled",this.id),t===e.length-1&&$("#bottomNewMention").css({display:"none"}),!1}))}}))};var f=()=>{document.getElementById("ep_rocketchat_iframe").contentWindow.postMessage({externalCommand:"userEtherpadStatus",status:"1"===clientVars.ep_profile_modal.userStatus?"loginNeeded":"LoggedIn"},"*")};var b=e=>{const t=new CustomEvent("ep_push_notification",{detail:{eventName:"notifyMe",data:e}});window.dispatchEvent(t)};var I=()=>{var e,d,p;e=window,d="message",p=e=>{const d=e.data.eventName,p=e.data.data;"notification"===d&&(e=>{if(!e.fromOpenedRoom){const r=pad.getPadId(),l=pad.getUserId(),d=clientVars.userAgent.isMobile,{name:p,fname:u,message:h}=e.notification.payload,g=p===`${r}-general-channel`?"general":p;if((o()||!1)?.toLowerCase()===g)return;let f=$(`#${g}_notification`);if(f.length||(f=$(`#${u}_notification`)),f.length||(f=$(`#${u?u.toLowerCase():""}_notification`)),!f.length)return;const I=f.attr("data-headerid");let _,S=n(g,l)||0;if(S=parseInt(S),[`@${l}`,"@all"].includes(h.msg))S++,a(g,l,S),_=$("#ep_rocketchat_mentionNotification").tmpl({unread:S}),$("body > header .shortMenue .btnChat .messageCount").text(S),f.html(_),b({title:"New message",body:"You have new message."}),m(I);else{const e=parseInt(t(g))||0;let o=0;if(e>0)o=e;else{let e=parseInt(i(g)||0);e++,s(g,e),o=e}_=$("#ep_rocketchat_unreadNotification").tmpl({unread:o+S}),f.html(_),y(I);let a=o+S,n=c().find("iframe").contents().find("#innerdocbody").find(`[headerid="${I}"]`)[0];n&&(n=n.shadowRoot,d||(0===a?(n.querySelector(".bubbleNotify").style.display="none",n.querySelector(".mobileIcon").style.display="block",n.querySelector(".mobileIcon").style.marginTop="5px"):a>0&&(n.querySelector(".bubbleNotify").style.display="block",n.querySelector(".mobileIcon").style.display="none",n.querySelector(".mobileIcon").style.marginTop="0")),a>9&&(a="9+",d&&n.querySelectorAll(".counter").forEach((e=>{e.style.marginLeft="-7px"}))),n.querySelectorAll(".counter").forEach((e=>{e.innerText=a})))}}})(p),"new-message"===d&&(e=>{const s=pad.getPadId(),i=e.name,d=pad.getUserId(),p=i===`${s}-general-channel`?"general":i,u=clientVars.userAgent.isMobile;if((o()||!1)?.toLowerCase()===p)return;let h=n(p,d)||0;h=parseInt(h);const g=$(`#${p}_notification`),f=g.attr("data-headerid");let I;if(h=parseInt(h),[`@${d}`,"@all"].includes(e.msg))h++,a(p,d,h),I=$("#ep_rocketchat_mentionNotification").tmpl({unread:h}),$("body > header .shortMenue .btnChat .messageCount").text(h),g.html(I),b({title:"New message",body:"You have new message."}),m(f);else{const e=parseInt(t(p))||0;let o=0;if(e>0)o=e;else{let e=parseInt(l(p))||0;e++,r(p,e),o=e}I=$("#ep_rocketchat_unreadNotification").tmpl({unread:o}),g.html(I),y(f);let a=o,n=c().find("iframe").contents().find("#innerdocbody").find(`[headerid="${f}"]`)[0];n&&(n=n.shadowRoot,u||(0===a?(n.querySelector(".bubbleNotify").style.display="none",n.querySelector(".mobileIcon").style.display="block",n.querySelector(".mobileIcon").style.marginTop="5px"):a>0&&(n.querySelector(".bubbleNotify").style.display="block",n.querySelector(".mobileIcon").style.display="none",n.querySelector(".mobileIcon").style.marginTop="0")),a>9&&(a="9+",u&&n.querySelectorAll(".counter").forEach((e=>{e.style.marginLeft="-7px"}))),n.querySelectorAll(".counter").forEach((e=>{e.innerText=a})))}})(p),"unread-changed-by-subscription"===d&&(({name:e,alert:a,unread:r,fname:s})=>{const d=e===`${clientVars.padId}-general-channel`?"general":e,p=parseInt(t(d))||0,u=clientVars.userAgent.isMobile;if(0===p&&!1===a&&0===r)return;const h=pad.getUserId();if((o()||!1)?.toLowerCase()===d)return;let g=$(`#${d}_notification`);if(g.length||(g=$(`#${s}_notification`)),g.length||(g=$(`#${s?s.toLowerCase():""}_notification`)),!g.length)return;const f=g.attr("data-headerid"),b=i(d),I=l(d),_=parseInt(b)||parseInt(I)||!1;let S,k=n(d,h)||0;if(k=parseInt(k),0===k){S=$("#ep_rocketchat_unreadNotification").tmpl({unread:p||_||r}),y(f);let e=p||_||r,t=c().find("iframe").contents().find("#innerdocbody").find(`[headerid="${f}"]`)[0];t&&(t=t.shadowRoot,u||(0===e?(t.querySelector(".bubbleNotify").style.display="none",t.querySelector(".mobileIcon").style.display="block",t.querySelector(".mobileIcon").style.marginTop="5px"):e>0&&(t.querySelector(".bubbleNotify").style.display="block",t.querySelector(".mobileIcon").style.display="none",t.querySelector(".mobileIcon").style.marginTop="0")),e>9&&(e="9+",u&&t.querySelectorAll(".counter").forEach((e=>{e.style.marginLeft="-7px"}))),t.querySelectorAll(".counter").forEach((t=>{t.innerText=e})))}else S=$("#ep_rocketchat_mentionNotification").tmpl({unread:k}),$("body > header .shortMenue .btnChat .messageCount").text(k),m(f);g.html(S)})(p),"chatLoading"===d&&$("#ep_rocketchat_iframe").animate({opacity:0},{duration:200,complete:()=>{$("#chat-loading").css({opacity:1}),$("#chat-loading").css({display:"flex"})}})},e.addEventListener?e.addEventListener(d,p,!1):e.attachEvent&&e.attachEvent(`on${d}`,p)};const _=(t,o)=>{const a=pad.getUserId(),{action:n,userId:r,padId:l,messageChatText:s}=o.payload;if("updateRocketChatAnonymousInterface"===n&&a===r&&f(o.payload),"updateRocketChatIframe"===n&&(a===r&&d(o.payload),p(o.payload)),"updateChannelsMessageCount"===n&&a===r&&(t=>{try{const o=t.data.channelsMessageCount,a=t.padId,n=clientVars.userAgent.isMobile;let r=localStorage.getItem("lastActiveHeader");r=r?r.toLowerCase():r,o.filter((e=>e.name!==r&&e.count>0)).forEach((t=>{const o=t.name===`${a}-general-channel`?"general":t.name;let r=$(`#${o}_notification`);const l=r.attr("data-headerid");let s=t.count;if(r.length||(r=$(`#${o.toLowerCase()}_notification`)),r.length||(r=$(`#${t.fname.toLowerCase()}_notification`)),!r.length)return;const i=$("#ep_rocketchat_unreadNotification").tmpl({unread:s});r.html(i),y(l),e(o,s);let d=c().find("iframe").contents().find("#innerdocbody").find(`[headerid="${l}"]`)[0];d&&(d=d.shadowRoot,n||(0===s?(d.querySelector(".bubbleNotify").style.display="none",d.querySelector(".mobileIcon").style.display="block",d.querySelector(".mobileIcon").style.marginTop="5px"):s>0&&(d.querySelector(".bubbleNotify").style.display="block",d.querySelector(".mobileIcon").style.display="none",d.querySelector(".mobileIcon").style.marginTop="0")),s>9&&(s="9+",n&&d.querySelectorAll(".counter").forEach((e=>{e.style.marginLeft="-7px"}))),d.querySelectorAll(".counter").forEach((e=>{e.innerText=s})))}))}catch(e){console.log(e)}})(o.payload),"updateOnlineUsersList"===n&&p(o.payload),"gatherUpHeaderIds"===n&&a===r&&u(o.payload),"EP_PROFILE_USER_LOGIN_UPDATE"===n&&a===r){const e={type:"ep_rocketchat",action:"ep_rocketchat_updateRocketChatUser",userId:a,padId:l,data:o.payload};pad.collabClient.sendMessage(e),f(o.payload)}if("EP_PROFILE_USER_LOGOUT_UPDATE"===n&&a===r){const e={type:"ep_rocketchat",action:"ep_rocketchat_updateRocketChatUser",userId:a,padId:l,data:{userName:"Anonymous",avatarUrlReset:!0,messageChatText:s}};pad.collabClient.sendMessage(e),f(o.payload)}if("EP_PROFILE_USER_IMAGE_CHANGE"===n&&a===r){const e={type:"ep_rocketchat",action:"ep_rocketchat_updateImageRocketChatUser",userId:a,padId:l};pad.collabClient.sendMessage(e)}if("recieveTitleMessage"===o.payload.action){const e=o.payload.message,t=e||pad.getPadId();t&&$("#parent_header_chat_room").text(t)}return[]},S=()=>{const e=pad.getUserId(),t=localStorage.getItem("lastActiveHeader"),o={type:"ep_rocketchat",action:"ep_rocketchat_updateOnlineUsersList",userId:e,padId:pad.getPadId(),data:{headerId:t}};return pad.collabClient.sendMessage(o),[]},k=()=>{const e=pad.getUserId(),t=localStorage.getItem("lastActiveHeader"),o={type:"ep_rocketchat",action:"ep_rocketchat_updateOnlineUsersList",userId:e,padId:pad.getPadId(),data:{headerId:t}};return pad.collabClient.sendMessage(o),[]};exports.aceInitialized=()=>($("#chaticon").hide(),$("#options-stickychat").prop("checked",!1),$("#options-stickychat").parent().hide(),$("#options-chatandusers").parent().hide(),I(),g(),[]),exports.handleClientMessage_CUSTOM=_,exports.handleClientMessage_USER_LEAVE=k,exports.handleClientMessage_USER_NEWINFO=S;//# sourceMappingURL=ep_rocketchat_bundle.js.map
